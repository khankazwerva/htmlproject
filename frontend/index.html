<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Онлайн-магазин</title>
    <style>
    /* === ОБНОВЛЕННЫЕ СТИЛИ === */
    
    /* Цветовая палитра */
    :root {
        --primary-color: #4361ee;
        --primary-dark: #3a56d4;
        --secondary-color: #7209b7;
        --accent-color: #4cc9f0;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --gray-light: #e9ecef;
        --gray-medium: #adb5bd;
        --gray-dark: #495057;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
        --border-radius: 10px;
        --border-radius-sm: 6px;
        --transition: all 0.3s ease;
    }
    
    /* Базовые стили */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        color: var(--dark-color);
        line-height: 1.6;
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    /* Заголовок */
    header {
        margin-bottom: 40px;
        padding: 25px 30px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        border-left: 5px solid var(--primary-color);
        transition: var(--transition);
    }
    
    header:hover {
        box-shadow: var(--shadow-lg), 0 0 0 1px rgba(67, 97, 238, 0.1);
    }
    
    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    h1 {
        font-size: 2.2rem;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        font-weight: 700;
        letter-spacing: -0.5px;
    }
    
    /* Навигация */
    .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
    }
    
    .nav-links a, .nav-links button {
        text-decoration: none;
        color: var(--primary-color);
        font-weight: 600;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        padding: 10px 18px;
        border-radius: 50px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }
    
    .nav-links a:hover, .nav-links button:hover {
        background: rgba(67, 97, 238, 0.1);
        transform: translateY(-2px);
    }
    
    .nav-links a::after, .nav-links button::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 2px;
        background: var(--primary-color);
        transition: var(--transition);
        transform: translateX(-50%);
    }
    
    .nav-links a:hover::after, .nav-links button:hover::after {
        width: 80%;
    }
    
    #cart-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        background: var(--danger-color);
        color: white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
        margin-left: 5px;
        padding: 0 6px;
    }
    
    /* Фильтры и поиск */
    .filters {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        background: white;
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 180px;
        flex: 1;
    }
    
    .filter-group label {
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--gray-dark);
        font-size: 14px;
    }
    
    .filter-group input,
    .filter-group select {
        padding: 12px 15px;
        border: 2px solid var(--gray-light);
        border-radius: var(--border-radius-sm);
        font-size: 14px;
        transition: var(--transition);
        background: white;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    .search-input {
        flex: 1;
        min-width: 300px;
        margin: 30px 0;
    }
    
    .search-input label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--gray-dark);
    }
    
    .search-input input {
        width: 100%;
        padding: 15px 20px;
        border: 2px solid var(--gray-light);
        border-radius: 50px;
        font-size: 16px;
        transition: var(--transition);
        background: white;
    }
    
    .search-input input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
    }
    
    .sort-controls {
        margin: 25px 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .sort-controls label {
        font-weight: 600;
        color: var(--gray-dark);
    }
    
    .sort-controls select {
        padding: 12px 20px;
        border: 2px solid var(--gray-light);
        border-radius: var(--border-radius-sm);
        font-size: 14px;
        transition: var(--transition);
        background: white;
        min-width: 200px;
    }
    
    /* Карточки товаров */
    .products {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
        margin-top: 30px;
    }
    
    .product-card {
        background: white;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
        border: 1px solid transparent;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-color);
    }
    
    .product-image {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius-sm);
        overflow: hidden;
        position: relative;
    }
    
    .product-image::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    }
    
    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    
    .product-card:hover .product-image img {
        transform: scale(1.05);
    }
    
    .product-name {
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 18px;
        color: var(--dark-color);
        line-height: 1.4;
    }
    
    .product-description {
        color: var(--gray-dark);
        font-size: 14px;
        margin-bottom: 10px;
        flex-grow: 1;
        line-height: 1.5;
    }
    
    .product-category {
        color: var(--primary-color);
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .product-price {
        font-weight: 700;
        color: var(--danger-color);
        font-size: 20px;
        margin-bottom: 8px;
    }
    
    .product-stock {
        font-size: 14px;
        padding: 5px 12px;
        border-radius: 20px;
        display: inline-block;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .product-stock:not(.out-of-stock) {
        background: rgba(46, 204, 113, 0.1);
        color: var(--success-color);
    }
    
    .product-stock.out-of-stock {
        background: rgba(231, 76, 60, 0.1);
        color: var(--danger-color);
    }
    
    .product-badge {
        display: inline-block;
        background: linear-gradient(90deg, var(--success-color), #27ae60);
        color: white;
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 4px;
        margin-top: 5px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }
    
    .product-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    /* Кнопки */
    .btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: var(--transition);
        text-align: center;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        background: linear-gradient(135deg, var(--primary-dark), #2f4fcc);
    }
    
    .btn:active {
        transform: translateY(0);
    }
    
    .btn:disabled {
        background: var(--gray-light);
        color: var(--gray-medium);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-outline {
        background: transparent;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
    }
    
    .btn-outline:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-success {
        background: linear-gradient(135deg, var(--success-color), #27ae60);
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #27ae60, #219653);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, var(--danger-color), #c0392b);
    }
    
    .btn-danger:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, var(--warning-color), #e67e22);
    }
    
    .btn-warning:hover {
        background: linear-gradient(135deg, #e67e22, #d35400);
    }
    
    /* Формы */
    .add-product-form, .edit-product-form {
        margin-top: 40px;
        padding: 30px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        border-top: 4px solid var(--primary-color);
    }
    
    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .form-group {
        flex: 1;
        min-width: 200px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--gray-dark);
        font-size: 14px;
    }
    
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--gray-light);
        border-radius: var(--border-radius-sm);
        font-size: 14px;
        transition: var(--transition);
        background: white;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    /* Скрытие неактивных страниц */
    .product-detail-page,
    .profile-page,
    .checkout-page {
        display: none;
    }
    
    /* Главная страница по умолчанию видна */
    #home-page {
        display: block;
    }
    
    /* Модальные окна */
    .cart-overlay, .auth-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: none;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
    }
    
    .cart-modal, .auth-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 500px;
        background: white;
        border-radius: var(--border-radius);
        padding: 30px;
        z-index: 1001;
        box-shadow: var(--shadow-lg);
        animation: slideUp 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translate(-50%, -40%);
        }
        to { 
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }
    
    /* Страница товара */
    .product-detail-page {
        background: white;
        padding: 30px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        animation: fadeIn 0.5s ease;
    }
    
    .product-detail-header {
        display: flex;
        gap: 40px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .product-detail-image {
        flex: 0 0 300px;
        height: 300px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-md);
    }
    
    .product-detail-info {
        flex: 1;
        min-width: 300px;
    }
    
    /* Вкладки */
    .profile-tabs, .auth-tabs {
        display: flex;
        margin-bottom: 30px;
        border-bottom: 2px solid var(--gray-light);
        gap: 10px;
    }
    
    .profile-tab, .auth-tab {
        padding: 12px 25px;
        cursor: pointer;
        background: none;
        border: none;
        font-weight: 600;
        color: var(--gray-dark);
        border-bottom: 3px solid transparent;
        transition: var(--transition);
        border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
    }
    
    .profile-tab:hover, .auth-tab:hover {
        color: var(--primary-color);
        background: rgba(67, 97, 238, 0.05);
    }
    
    .profile-tab.active, .auth-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        background: rgba(67, 97, 238, 0.1);
    }
    
    /* Контент вкладок */
    .profile-content {
        display: none;
    }
    
    .profile-content.active {
        display: block;
    }
    
    .auth-content {
        display: none;
    }
    
    .auth-content.active {
        display: block;
    }
    
    /* Уведомления */
    .toast {
        padding: 15px 20px;
        border-radius: var(--border-radius-sm);
        color: white;
        font-weight: 600;
        box-shadow: var(--shadow-lg);
        animation: slideIn 0.3s forwards, fadeOut 3s forwards 2.7s;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .toast::before {
        font-size: 18px;
    }
    
    .toast.success { 
        background: linear-gradient(135deg, var(--success-color), #27ae60);
    }
    
    .toast.error { 
        background: linear-gradient(135deg, var(--danger-color), #c0392b);
    }
    
    .toast.info { 
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    }
    
    .toast.warning { 
        background: linear-gradient(135deg, var(--warning-color), #e67e22);
    }
    
    /* Загрузка */
    .loading-spinner {
        border: 3px solid var(--gray-light);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
    }
    
    /* Адаптивность */
    @media (max-width: 1024px) {
        .products {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        body {
            padding: 15px;
        }
        
        .header-top {
            flex-direction: column;
            gap: 20px;
            align-items: stretch;
        }
        
        .nav-links {
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .filters {
            flex-direction: column;
            gap: 15px;
        }
        
        .filter-group {
            min-width: 100%;
        }
        
        .search-input {
            min-width: 100%;
        }
        
        .product-detail-header {
            flex-direction: column;
            gap: 25px;
        }
        
        .product-detail-image {
            width: 100%;
            flex: none;
        }
        
        .form-row {
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            min-width: 100%;
        }
        
        .cart-modal, .auth-modal {
            width: 95%;
            padding: 20px;
        }
        
        .checkout-form {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .checkout-column.full {
            grid-column: 1;
        }
    }
    
    @media (max-width: 480px) {
        h1 {
            font-size: 1.8rem;
            text-align: center;
        }
        
        .products {
            grid-template-columns: 1fr;
        }
        
        .product-actions {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
            justify-content: center;
        }
        
        .profile-tabs, .auth-tabs {
            flex-direction: column;
            border-bottom: none;
            gap: 5px;
        }
        
        .profile-tab, .auth-tab {
            border-radius: var(--border-radius-sm);
            border-bottom: none;
            text-align: left;
        }
        
        .profile-tab.active, .auth-tab.active {
            border-bottom: none;
        }
    }
    
    /* Микро-интеракции */
    .product-card .btn, .cart-item .btn {
        transition: all 0.2s ease;
    }
    
    .product-card .btn:active, .cart-item .btn:active {
        transform: scale(0.98);
    }
    
    /* Плавный скролл */
    html {
        scroll-behavior: smooth;
    }
    
    /* Кастомный скроллбар */
    ::-webkit-scrollbar {
        width: 10px;
    }
    
    ::-webkit-scrollbar-track {
        background: var(--gray-light);
        border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }
    
    /* Эффект фокуса для доступности */
    *:focus {
        outline: 2px solid var(--accent-color);
        outline-offset: 2px;
    }
    
    *:focus:not(:focus-visible) {
        outline: none;
    }
    
    *:focus-visible {
        outline: 2px solid var(--accent-color);
        outline-offset: 2px;
    }
    
    /* Анимации */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
        from { 
            opacity: 0;
            transform: translateX(100%);
        }
        to { 
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    
    /* Эффект свечения для важных элементов */
    .glow-effect {
        position: relative;
    }
    
    .glow-effect::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, var(--primary-color), var(--accent-color), var(--secondary-color));
        border-radius: inherit;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .glow-effect:hover::before {
        opacity: 0.3;
    }
    
    /* Улучшенные тени для глубины */
    .depth-1 { box-shadow: var(--shadow-sm); }
    .depth-2 { box-shadow: var(--shadow-md); }
    .depth-3 { box-shadow: var(--shadow-lg); }
    
    /* Градиентный текст */
    .gradient-text {
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        font-weight: 700;
    }
    
    /* Эффект наклона для заголовков */
    .tilted {
        display: inline-block;
        transform: rotate(-2deg);
        transform-origin: left center;
    }
</style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>Онлайн-магазин</h1>
                <div class="nav-links">
                    <a href="#" onclick="showPage('home')">Главная</a>
                    <a href="#" onclick="openCart()">Корзина (<span id="cart-count">0</span>)</a>
                    <a href="#" onclick="showPage('profile')">Личный кабинет</a>
                    <button id="login-btn" class="btn" style="padding: 5px 10px; font-size: 14px;">Войти</button>
                </div>
            </div>
        </header>

        <!-- Главная страница -->
        <div id="home-page">
            <div class="filters">
                <div class="filter-group">
                    <label for="category">Категория:</label>
                    <select id="category">
                        <option value="">Все категории</option>
                        <option value="electronics">Электроника</option>
                        <option value="clothing">Одежда</option>
                        <option value="books">Книги</option>
                        <option value="food">Продукты</option>
                        <option value="other">Другое</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="min-price">Мин. цена:</label>
                    <input type="number" id="min-price" placeholder="От" min="0">
                </div>
                <div class="filter-group">
                    <label for="max-price">Макс. цена:</label>
                    <input type="number" id="max-price" placeholder="До" min="0">
                </div>
            </div>
            <div class="sort-controls">
                <label for="sort">Сортировка:</label>
                <select id="sort">
                    <option value="">По умолчанию</option>
                    <option value="name">Название (А-Я)</option>
                    <option value="-name">Название (Я-А)</option>
                    <option value="price">Цена (по возрастанию)</option>
                    <option value="-price">Цена (по убыванию)</option>
                </select>
            </div>
            <div class="search-input">
                <label for="search">Поиск товаров:</label>
                <input type="text" id="search" placeholder="Введите название или описание...">
            </div>
            <div class="products" id="products-container">
                <div class="loading" id="products-loading">
                    <div class="loading-spinner"></div>
                    Загрузка товаров...
                </div>
            </div>
        </div>

        <!-- Форма добавления товара (для админа) -->
        <section class="add-product-form" id="add-product-section">
            <h2>Добавить товар</h2>
            <form id="add-product-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-name">Название:</label>
                        <input type="text" id="new-name" required>
                    </div>
                    <div class="form-group">
                        <label for="new-price">Цена:</label>
                        <input type="number" id="new-price" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="new-category">Категория:</label>
                        <select id="new-category" required>
                            <option value="">Выберите категорию</option>
                            <option value="electronics">Электроника</option>
                            <option value="clothing">Одежда</option>
                            <option value="books">Книги</option>
                            <option value="food">Продукты</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new-stock">Количество:</label>
                        <input type="number" id="new-stock" required min="0" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="new-description">Описание:</label>
                    <textarea id="new-description" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="new-image">Изображение (URL):</label>
                    <input type="text" id="new-image" placeholder="https://example.com/image.jpg">
                </div>
                <button type="submit" class="btn btn-success">Добавить товар</button>
            </form>
        </section>

        <!-- Страница товара -->
        <div class="product-detail-page" id="product-detail-page">
            <!-- Элемент загрузки для страницы товара -->
            <div class="loading" id="product-detail-loading" style="display: none;">
                <div class="loading-spinner"></div>
                Загрузка товара...
            </div>
            
            <div class="product-detail-header">
                <div class="product-detail-image">
                    <img id="detail-image" src="" alt="Изображение товара" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9IiNlZWVlZWUiPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIyMCI+8J+SpSBUZW1wZXJhcnkgSW1hZ2U8L3RleHQ+PC9zdmc+'">
                </div>
                <div class="product-detail-info">
                    <h2 id="detail-name" class="product-detail-name"></h2>
                    <div id="detail-category" class="product-detail-category"></div>
                    <div id="detail-price" class="product-detail-price"></div>
                    <div id="detail-stock" class="product-detail-stock"></div>
                    <div class="product-detail-actions">
                        <button class="btn btn-success" id="add-to-cart-btn" onclick="addToCart(currentProductId)">В корзину</button>
                        <button class="btn btn-outline" onclick="toggleFavorite(currentProductId)" id="favorite-btn">
                            <span id="favorite-icon">♡</span> <span id="favorite-text">В избранное</span>
                        </button>
                        <button class="btn" onclick="showPage('home')">Назад к товарам</button>
                    </div>
                </div>
            </div>
            <div class="product-detail-description">
                <h3>Описание</h3>
                <p id="detail-description"></p>
            </div>
            
            <!-- Форма редактирования (для админа) -->
            <div class="edit-product-form" id="edit-product-form">
                <h3>Редактировать товар</h3>
                <div class="form-group">
                    <label for="edit-name">Название:</label>
                    <input type="text" id="edit-name">
                </div>
                <div class="form-group">
                    <label for="edit-price">Цена:</label>
                    <input type="number" id="edit-price" min="0">
                </div>
                <div class="form-group">
                    <label for="edit-stock">Количество:</label>
                    <input type="number" id="edit-stock" min="0">
                </div>
                <div class="form-group">
                    <label for="edit-description">Описание:</label>
                    <textarea id="edit-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-image">Изображение (URL):</label>
                    <input type="text" id="edit-image">
                </div>
                <div class="form-group">
                    <label for="edit-category">Категория:</label>
                    <select id="edit-category">
                        <option value="electronics">Электроника</option>
                        <option value="clothing">Одежда</option>
                        <option value="books">Книги</option>
                        <option value="food">Продукты</option>
                        <option value="other">Другое</option>
                    </select>
                </div>
                <div class="product-detail-actions">
                    <button class="btn btn-success" onclick="updateProduct()">Сохранить изменения</button>
                    <button class="btn btn-danger" onclick="deleteProduct()">Удалить товар</button>
                </div>
            </div>
        </div>

        <!-- Личный кабинет -->
        <div class="profile-page" id="profile-page">
            <h2 id="profile-title">Личный кабинет</h2>
            <div class="profile-tabs">
                <button class="profile-tab active" data-tab="profile">Профиль</button>
                <button class="profile-tab" data-tab="orders">Заказы</button>
                <button class="profile-tab" data-tab="favorites" id="favorites-tab">Избранное</button>
            </div>
            
            <div class="profile-content active" id="tab-profile">
                <div class="form-group">
                    <label for="profile-name">Имя:</label>
                    <input type="text" id="profile-name">
                </div>
                <div class="form-group">
                    <label for="profile-email">Email:</label>
                    <input type="email" id="profile-email">
                </div>
                <button class="btn btn-success" onclick="updateProfile()">Сохранить изменения</button>
                <button class="btn btn-danger" onclick="logout()" style="margin-top: 10px;">Выйти</button>
            </div>
            
            <div class="profile-content" id="tab-orders">
                <h3>Мои заказы</h3>
                <div id="orders-list">
                    <div class="loading" id="orders-loading">
                        <div class="loading-spinner"></div>
                        Загрузка заказов...
                    </div>
                </div>
            </div>
            
            <div class="profile-content" id="tab-favorites">
                <h3>Избранное</h3>
                <div class="products" id="favorites-list">
                    <div class="loading" id="favorites-loading">
                        <div class="loading-spinner"></div>
                        Загрузка избранного...
                    </div>
                </div>
            </div>
        </div>

        <!-- Оформление заказа -->
        <div class="checkout-page" id="checkout-page">
            <h2>Оформление заказа</h2>
            <div class="checkout-form">
                <div class="checkout-column">
                    <h3>Контактная информация</h3>
                    <div class="form-group">
                        <label for="checkout-name">Имя *</label>
                        <input type="text" id="checkout-name" required>
                    </div>
                    <div class="form-group">
                        <label for="checkout-email">Email *</label>
                        <input type="email" id="checkout-email" required>
                    </div>
                    <div class="form-group">
                        <label for="checkout-phone">Телефон</label>
                        <input type="tel" id="checkout-phone" placeholder="+7 (999) 123-45-67">
                    </div>
                </div>
                
                <div class="checkout-column">
                    <h3>Доставка</h3>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="delivery" value="pickup" checked> Самовывоз
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="delivery" value="courier"> Курьером
                        </label>
                    </div>
                    <div id="address-field" style="display: none;">
                        <div class="form-group">
                            <label for="checkout-address">Адрес *</label>
                            <input type="text" id="checkout-address" required placeholder="ул. Примерная, д. 10, кв. 5">
                        </div>
                    </div>
                    <div id="pickup-point-info" class="pickup-point">
                        <strong>Пункт выдачи:</strong><br>
                        г. Москва, ул. Примерная, д. 10<br>
                        ТЦ "Центральный", 2 этаж, павильон 42<br>
                        Режим работы: 10:00-20:00 ежедневно
                    </div>
                </div>
                
                <div class="checkout-column full">
                    <h3>Оплата</h3>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="payment" value="cash" checked> Наличными при получении
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="payment" value="card"> Картой при получении
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="payment" value="online"> Онлайн-оплата
                        </label>
                    </div>
                </div>
                
                <div class="checkout-column">
                    <h3>Итого</h3>
                    <div class="cart-summary" id="checkout-summary">
                        <div class="loading" id="checkout-loading">
                            <div class="loading-spinner"></div>
                            Загрузка корзины...
                        </div>
                    </div>
                    <button class="btn btn-success checkout-btn" onclick="createOrder()" style="width: 100%; margin-top: 20px;">
                        Оформить заказ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно корзины -->
    <div class="cart-overlay" id="cart-overlay">
        <div class="cart-modal">
            <div class="cart-header">
                <h2>Корзина</h2>
                <button class="close-cart" onclick="closeCart()">&times;</button>
            </div>
            <div class="cart-items" id="cart-items">
                <div class="loading" id="cart-loading">
                    <div class="loading-spinner"></div>
                    Загрузка корзины...
                </div>
            </div>
            <div class="cart-controls">
                <button class="btn btn-danger" onclick="clearCart()">Очистить корзину</button>
                <button class="btn btn-success checkout-btn" onclick="goToCheckout()">Оформить заказ</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно авторизации -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-modal">
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Вход</button>
                <button class="auth-tab" data-tab="register">Регистрация</button>
            </div>
            
            <div class="auth-content active" id="auth-login">
                <div class="form-group">
                    <label for="login-email">Email:</label>
                    <input type="email" id="login-email" placeholder="ваш@email.com">
                </div>
                <div class="form-group">
                    <label for="login-password">Пароль:</label>
                    <input type="password" id="login-password" placeholder="Пароль">
                </div>
                <button class="btn btn-success" onclick="login()" style="width: 100%;">Войти</button>
                <div style="margin-top: 15px; text-align: center; font-size: 14px; color: #666;">
                    Для теста: admin@example.com / admin123
                </div>
            </div>
            
            <div class="auth-content" id="auth-register">
                <div class="form-group">
                    <label for="register-name">Имя:</label>
                    <input type="text" id="register-name" placeholder="Ваше имя">
                </div>
                <div class="form-group">
                    <label for="register-email">Email:</label>
                    <input type="email" id="register-email" placeholder="ваш@email.com">
                </div>
                <div class="form-group">
                    <label for="register-password">Пароль:</label>
                    <input type="password" id="register-password" placeholder="Не менее 6 символов">
                </div>
                <button class="btn btn-success" onclick="register()" style="width: 100%;">Зарегистрироваться</button>
            </div>
        </div>
    </div>

    <!-- Контейнер для уведомлений -->
    <div id="toast-container"></div>

            <script>
        // ====== КОНСТАНТЫ И ПЕРЕМЕННЫЕ ======
        const API_BASE_URL = 'http://localhost:5000';
        let currentProductId = null;
        let currentUser = null;

        // ====== УТИЛИТЫ ======
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const defaultHeaders = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                defaultHeaders['Authorization'] = `Bearer ${token}`;
            }
            
            const headers = { ...defaultHeaders, ...options.headers };
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    currentUser = null;
                    updateUIForRole();
                    showToast('Сессия истекла. Войдите снова.', 'error');
                    return null;
                }
                
                if (!response.ok) {
                    let errorMessage = 'Ошибка сервера';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        // Не удалось распарсить JSON
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`API Error ${endpoint}:`, error);
                
                let userMessage = error.message;
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    userMessage = 'Нет соединения с сервером. Проверьте, запущен ли backend.';
                }
                
                showToast(userMessage, 'error');
                return null;
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            }).format(price);
        }

        function getCategoryName(category) {
            const categories = {
                'electronics': 'Электроника',
                'clothing': 'Одежда',
                'books': 'Книги',
                'food': 'Продукты',
                'other': 'Другое'
            };
            return categories[category] || category;
        }

        // ====== АВТОРИЗАЦИЯ ======
        async function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            if (!email || !password) {
                showToast('Заполните все поля', 'error');
                return;
            }
            
            const data = await apiRequest('/api/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            
            if (data && data.token) {
                localStorage.setItem('token', data.token);
                currentUser = data.user;
                updateUIForRole();
                closeAuthModal();
                showToast(`Добро пожаловать, ${currentUser.name}!`, 'success');
                updateCartCount();
            }
        }

        async function register() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            
            if (!name || !email || !password) {
                showToast('Заполните все поля', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Пароль должен быть не менее 6 символов', 'error');
                return;
            }
            
            const data = await apiRequest('/api/auth/register', {
                method: 'POST',
                body: JSON.stringify({ name, email, password })
            });
            
            if (data && data.token) {
                localStorage.setItem('token', data.token);
                currentUser = data.user;
                updateUIForRole();
                closeAuthModal();
                showToast('Регистрация успешна!', 'success');
                updateCartCount();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            currentUser = null;
            updateUIForRole();
            showPage('home');
            showToast('Вы вышли из системы', 'info');
        }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) return false;
            
            const user = await apiRequest('/api/auth/me');
            if (user) {
                currentUser = user;
                updateUIForRole();
                updateCartCount();
                return true;
            }
            return false;
        }

        function showAuthModal() {
            document.getElementById('auth-overlay').style.display = 'block';
        }

        function closeAuthModal() {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('register-name').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
        }

        // ====== ТОВАРЫ ======
        async function fetchProducts() {
            const category = document.getElementById('category').value;
            const minPrice = document.getElementById('min-price').value;
            const maxPrice = document.getElementById('max-price').value;
            const search = document.getElementById('search').value;
            const sort = document.getElementById('sort').value;
            
            let url = '/api/products?';
            const params = [];
            
            if (category) params.push(`category=${encodeURIComponent(category)}`);
            if (minPrice) params.push(`minPrice=${minPrice}`);
            if (maxPrice) params.push(`maxPrice=${maxPrice}`);
            if (search) params.push(`search=${encodeURIComponent(search)}`);
            if (sort) params.push(`sort=${sort}`);
            
            url += params.join('&');
            
            const response = await apiRequest(url);
            
            if (response && Array.isArray(response)) {
                renderProducts(response);
            } else {
                const container = document.getElementById('products-container');
                container.innerHTML = '<div class="no-products">Ошибка загрузки товаров</div>';
            }
        }

        function renderProducts(products) {
            const container = document.getElementById('products-container');
            
            if (!Array.isArray(products)) {
                container.innerHTML = '<div class="no-products">Ошибка: данные не являются массивом</div>';
                return;
            }
            
            if (products.length === 0) {
                container.innerHTML = '<div class="no-products">Товары не найдены</div>';
                return;
            }
            
            container.innerHTML = '';
            
            products.forEach(product => {
                const isInStock = product.stock > 0;
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="${product.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9IiNlZWVlZWUiPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIyMCI+8J+SpSBUZW1wZXJhcnkgSW1hZ2U8L3RleHQ+PC9zdmc+'}" 
                             alt="${product.name}" 
                             loading="lazy"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9IiNlZWVlZWUiPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIyMCI+8J+SpSBUZW1wZXJhcnkgSW1hZ2U8L3RleHQ+PC9zdmc+'">
                    </div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-description">${product.description ? product.description.substring(0, 80) : ''}${product.description && product.description.length > 80 ? '...' : ''}</div>
                    <div class="product-category">${getCategoryName(product.category)}</div>
                    <div class="product-price">${formatPrice(product.price)}</div>
                    <div class="product-stock ${isInStock ? '' : 'out-of-stock'}">
                        ${isInStock ? `В наличии: ${product.stock} шт.` : 'Нет в наличии'}
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-success" onclick="showProduct('${product._id}')">Подробнее</button>
                        ${isInStock ? `<button class="btn" onclick="addToCart('${product._id}')">В корзину</button>` : 
                          '<button class="btn" disabled>Нет в наличии</button>'}
                    </div>
                `;
                container.appendChild(productCard);
            });
        }

        async function showProduct(productId) {
            try {
                const product = await apiRequest(`/api/products/${productId}`);
                
                if (!product) {
                    showToast('Товар не найден', 'error');
                    return;
                }
                
                currentProductId = productId;
                
                // Показываем страницу товара
                document.getElementById('home-page').style.display = 'none';
                document.getElementById('product-detail-page').style.display = 'block';
                
                // Заполняем данные
                const isInStock = product.stock > 0;
                document.getElementById('detail-image').src = product.image || '';
                document.getElementById('detail-name').textContent = product.name;
                document.getElementById('detail-category').textContent = `Категория: ${getCategoryName(product.category)}`;
                document.getElementById('detail-price').textContent = formatPrice(product.price);
                document.getElementById('detail-stock').textContent = isInStock ? 
                    `В наличии: ${product.stock} шт.` : 'Нет в наличии';
                document.getElementById('detail-stock').className = `product-detail-stock ${isInStock ? 'in-stock' : 'out-of-stock'}`;
                document.getElementById('detail-description').textContent = product.description || '';
                
                // Обновляем кнопку корзины
                const addToCartBtn = document.getElementById('add-to-cart-btn');
                if (isInStock) {
                    addToCartBtn.disabled = false;
                    addToCartBtn.textContent = 'В корзину';
                    addToCartBtn.className = 'btn btn-success';
                } else {
                    addToCartBtn.disabled = true;
                    addToCartBtn.textContent = 'Нет в наличии';
                    addToCartBtn.className = 'btn';
                }
                
                // Заполняем форму редактирования
                document.getElementById('edit-name').value = product.name;
                document.getElementById('edit-price').value = product.price;
                document.getElementById('edit-stock').value = product.stock;
                document.getElementById('edit-description').value = product.description || '';
                document.getElementById('edit-image').value = product.image || '';
                document.getElementById('edit-category').value = product.category;
                
                // Обновляем UI
                updateUIForRole();
            } catch (error) {
                showToast('Ошибка при загрузке товара', 'error');
            }
        }

        async function addProduct(event) {
            event.preventDefault();
            
            const product = {
                name: document.getElementById('new-name').value.trim(),
                description: document.getElementById('new-description').value.trim(),
                price: parseFloat(document.getElementById('new-price').value),
                category: document.getElementById('new-category').value,
                stock: parseInt(document.getElementById('new-stock').value),
                image: document.getElementById('new-image').value.trim() || ''
            };
            
            const result = await apiRequest('/api/products', {
                method: 'POST',
                body: JSON.stringify(product)
            });
            
            if (result) {
                document.getElementById('add-product-form').reset();
                fetchProducts();
                showToast('Товар успешно добавлен', 'success');
            }
        }

        async function updateProduct() {
            if (!currentProductId) return;
            
            const product = {
                name: document.getElementById('edit-name').value.trim(),
                description: document.getElementById('edit-description').value.trim(),
                price: parseFloat(document.getElementById('edit-price').value),
                stock: parseInt(document.getElementById('edit-stock').value),
                image: document.getElementById('edit-image').value.trim() || '',
                category: document.getElementById('edit-category').value
            };
            
            const result = await apiRequest(`/api/products/${currentProductId}`, {
                method: 'PUT',
                body: JSON.stringify(product)
            });
            
            if (result) {
                showProduct(currentProductId);
                fetchProducts();
                showToast('Товар успешно обновлен', 'success');
            }
        }

        async function deleteProduct() {
            if (!currentProductId) return;
            
            if (!confirm('Вы уверены, что хотите удалить этот товар?')) return;
            
            const result = await apiRequest(`/api/products/${currentProductId}`, {
                method: 'DELETE'
            });
            
            if (result) {
                showToast('Товар успешно удален', 'info');
                showPage('home');
            }
        }

        // ====== КОРЗИНА ======
        async function updateCartCount() {
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('cart-count').textContent = '0';
                return;
            }
            
            try {
                const response = await apiRequest('/api/cart/count');
                if (response && response.count !== undefined) {
                    document.getElementById('cart-count').textContent = response.count;
                } else {
                    document.getElementById('cart-count').textContent = '0';
                }
            } catch (error) {
                document.getElementById('cart-count').textContent = '0';
            }
        }

        async function addToCart(productId) {
            const token = localStorage.getItem('token');
            
            if (!token) {
                showToast('Войдите в систему, чтобы добавить товар в корзину', 'error');
                showAuthModal();
                return;
            }
            
            try {
                const result = await apiRequest('/api/cart', {
                    method: 'POST',
                    body: JSON.stringify({ productId, quantity: 1 })
                });
                
                if (result) {
                    updateCartCount();
                    showToast('Товар добавлен в корзину', 'success');
                    
                    if (document.getElementById('cart-overlay').style.display === 'block') {
                        await renderCartItems();
                    }
                }
            } catch (error) {
                showToast('Ошибка при добавлении в корзину', 'error');
            }
        }

        async function renderCartItems() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Загрузка корзины...</div>';
            
            try {
                const cart = await apiRequest('/api/cart');
                
                if (!cart || !cart.items || cart.items.length === 0) {
                    container.innerHTML = '<p>Корзина пуста</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                cart.items.forEach(item => {
                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item';
                    cartItem.innerHTML = `
                        <div class="cart-item-info">
                            <div><strong>${item.name}</strong></div>
                            <div>${formatPrice(item.price)}</div>
                        </div>
                        <div class="cart-item-actions">
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="updateCartQuantity('${item.productId}', ${item.quantity - 1})">-</button>
                                <input type="number" class="quantity-input" value="${item.quantity}" min="1" 
                                       onchange="updateCartQuantity('${item.productId}', parseInt(this.value))">
                                <button class="quantity-btn" onclick="updateCartQuantity('${item.productId}', ${item.quantity + 1})">+</button>
                            </div>
                            <button class="btn btn-danger" onclick="removeFromCart('${item.productId}')" style="padding: 5px 10px; font-size: 14px;">
                                Удалить
                            </button>
                        </div>
                    `;
                    container.appendChild(cartItem);
                });
            } catch (error) {
                container.innerHTML = '<p>Ошибка при загрузке корзины</p>';
            }
        }

        async function updateCartQuantity(productId, quantity) {
            if (quantity <= 0) {
                await removeFromCart(productId);
                return;
            }
            
            const result = await apiRequest(`/api/cart/${productId}`, {
                method: 'PUT',
                body: JSON.stringify({ quantity })
            });
            
            if (result) {
                await renderCartItems();
                updateCartCount();
            }
        }

        async function removeFromCart(productId) {
            const result = await apiRequest(`/api/cart/${productId}`, {
                method: 'DELETE'
            });
            
            if (result) {
                await renderCartItems();
                updateCartCount();
                showToast('Товар удален из корзины', 'info');
            }
        }

        async function clearCart() {
            if (!confirm('Вы уверены, что хотите очистить корзину?')) return;
            
            const result = await apiRequest('/api/cart', {
                method: 'DELETE'
            });
            
            if (result) {
                await renderCartItems();
                updateCartCount();
                showToast('Корзина очищена', 'info');
            }
        }

        // ====== ИЗБРАННОЕ ======
        async function checkFavoriteStatus(productId) {
            if (!currentUser) return;
            
            try {
                const favorites = await apiRequest('/api/favorites');
                if (!favorites || !Array.isArray(favorites)) return;
                
                const isFavorite = favorites.some(fav => fav._id === productId);
                
                const icon = document.getElementById('favorite-icon');
                const text = document.getElementById('favorite-text');
                
                if (icon && text) {
                    if (isFavorite) {
                        icon.textContent = '❤️';
                        text.textContent = 'В избранном';
                    } else {
                        icon.textContent = '♡';
                        text.textContent = 'В избранное';
                    }
                }
            } catch (error) {
                // Игнорируем ошибки
            }
        }

        async function toggleFavorite(productId) {
            if (!currentUser) {
                showToast('Войдите в систему, чтобы добавлять товары в избранное', 'error');
                showAuthModal();
                return;
            }
            
            try {
                const favorites = await apiRequest('/api/favorites');
                const isFavorite = favorites.some(fav => fav._id === productId);
                
                if (isFavorite) {
                    await apiRequest(`/api/favorites/${productId}`, { method: 'DELETE' });
                    showToast('Товар удален из избранного', 'info');
                } else {
                    await apiRequest('/api/favorites', {
                        method: 'POST',
                        body: JSON.stringify({ productId })
                    });
                    showToast('Товар добавлен в избранное', 'success');
                }
                
                await checkFavoriteStatus(productId);
            } catch (error) {
                showToast('Ошибка при работе с избранным', 'error');
            }
        }

        async function loadFavorites() {
            const container = document.getElementById('favorites-list');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Загрузка избранного...</div>';
            
            try {
                const favorites = await apiRequest('/api/favorites');
                
                if (!favorites || !Array.isArray(favorites)) {
                    container.innerHTML = '<div class="no-products">Ошибка при загрузке избранного</div>';
                    return;
                }
                
                if (favorites.length === 0) {
                    container.innerHTML = '<div class="no-products">Нет избранных товаров</div>';
                    return;
                }
                
                container.innerHTML = '';
                
                favorites.forEach(product => {
                    const isInStock = product.stock > 0;
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.innerHTML = `
                        <div class="product-image">
                            <img src="${product.image || ''}" alt="${product.name}" loading="lazy"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9IiNlZWVlZWUiPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIyMCI+8J+SpSBUZW1wZXJhcnkgSW1hZ2U8L3RleHQ+PC9zdmc+'">
                        </div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-description">${(product.description || '').substring(0, 80)}${(product.description || '').length > 80 ? '...' : ''}</div>
                        <div class="product-price">${formatPrice(product.price)}</div>
                        <div class="product-stock ${isInStock ? '' : 'out-of-stock'}">
                            ${isInStock ? `В наличии: ${product.stock} шт.` : 'Нет в наличии'}
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-success" onclick="showProduct('${product._id}')">Подробнее</button>
                            <button class="btn btn-danger" onclick="toggleFavorite('${product._id}')">Удалить</button>
                        </div>
                    `;
                    container.appendChild(productCard);
                });
            } catch (error) {
                container.innerHTML = '<div class="no-products">Ошибка при загрузке избранного</div>';
            }
        }

        // ====== ЗАКАЗЫ ======
        async function loadOrders() {
            const container = document.getElementById('orders-list');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Загрузка заказов...</div>';
            
            try {
                let orders;
                if (currentUser && currentUser.role === 'admin') {
                    orders = await apiRequest('/api/orders');
                } else {
                    orders = await apiRequest('/api/orders/my');
                }
                
                if (!orders || !Array.isArray(orders)) {
                    container.innerHTML = '<p>Ошибка при загрузке заказов</p>';
                    return;
                }
                
                if (orders.length === 0) {
                    container.innerHTML = '<p>У вас пока нет заказов</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                orders.forEach(order => {
                    const orderDate = new Date(order.createdAt).toLocaleDateString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.innerHTML = `
                        <div class="order-header">
                            <div><strong>Заказ #${order._id ? order._id.toString().substring(18, 24) : 'N/A'}</strong></div>
                            <div class="order-status status-${order.status}">${order.status || 'Ожидает'}</div>
                        </div>
                        <div>Дата: ${orderDate}</div>
                        <div>Сумма: ${formatPrice(order.totalAmount)}</div>
                        <div>Статус: ${order.status || 'Ожидает'}</div>
                    `;
                    container.appendChild(orderItem);
                });
            } catch (error) {
                container.innerHTML = '<p>Ошибка при загрузке заказов</p>';
            }
        }

        async function goToCheckout() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                showToast('Войдите в систему для оформления заказа', 'error');
                showAuthModal();
                return;
            }
            
            const cart = await apiRequest('/api/cart');
            if (!cart || !cart.items || cart.items.length === 0) {
                showToast('Корзина пуста', 'error');
                return;
            }
            
            closeCart();
            await loadCheckoutSummary();
            showPage('checkout');
        }

        async function loadCheckoutSummary() {
            const summaryEl = document.getElementById('checkout-summary');
            summaryEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Загрузка корзины...</div>';
            
            try {
                const cart = await apiRequest('/api/cart');
                
                if (!cart || !cart.items) {
                    summaryEl.innerHTML = '<p>Ошибка при загрузке корзины</p>';
                    return;
                }
                
                summaryEl.innerHTML = '';
                
                let total = 0;
                cart.items.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cart-summary-item';
                    itemDiv.innerHTML = `
                        <span>${item.name} × ${item.quantity}</span>
                        <span>${formatPrice(itemTotal)}</span>
                    `;
                    summaryEl.appendChild(itemDiv);
                });
                
                const totalDiv = document.createElement('div');
                totalDiv.className = 'cart-total';
                totalDiv.innerHTML = `
                    <span>Итого:</span>
                    <span>${formatPrice(total)}</span>
                `;
                summaryEl.appendChild(totalDiv);
            } catch (error) {
                summaryEl.innerHTML = '<p>Ошибка при загрузке корзины</p>';
            }
        }

        async function createOrder() {
            const name = document.getElementById('checkout-name').value.trim();
            const email = document.getElementById('checkout-email').value.trim();
            const phone = document.getElementById('checkout-phone').value.trim();
            const delivery = document.querySelector('input[name="delivery"]:checked').value;
            const address = delivery === 'courier' ? document.getElementById('checkout-address').value.trim() : '';
            const payment = document.querySelector('input[name="payment"]:checked').value;
            
            if (!name || !email) {
                showToast('Заполните обязательные поля (Имя и Email)', 'error');
                return;
            }
            
            if (delivery === 'courier' && !address) {
                showToast('Введите адрес доставки', 'error');
                return;
            }
            
            const cart = await apiRequest('/api/cart');
            if (!cart || !cart.items || cart.items.length === 0) {
                showToast('Корзина пуста', 'error');
                return;
            }
            
            const totalAmount = cart.items.reduce((sum, item) => {
                return sum + (item.price * item.quantity);
            }, 0);
            
            const orderData = {
                items: cart.items.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                totalAmount,
                shippingAddress: delivery === 'courier' ? { street: address } : null,
                paymentMethod: payment,
                customerInfo: { 
                    name, 
                    email, 
                    phone: phone || '' 
                }
            };
            
            console.log('Отправляемые данные заказа:', orderData);
            
            const result = await apiRequest('/api/orders', {
                method: 'POST',
                body: JSON.stringify(orderData)
            });
            
            if (result) {
                await apiRequest('/api/cart', { method: 'DELETE' });
                updateCartCount();
                
                showToast('Заказ успешно оформлен! С вами свяжется менеджер.', 'success');
                showPage('home');
            }
        }

        // ====== ПРОФИЛЬ ======
        async function loadProfile() {
            const user = await apiRequest('/api/auth/me');
            if (user) {
                document.getElementById('profile-name').value = user.name || '';
                document.getElementById('profile-email').value = user.email || '';
            }
        }

        async function updateProfile() {
            const name = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            
            const result = await apiRequest('/api/auth/update', {
                method: 'PUT',
                body: JSON.stringify({ name, email })
            });
            
            if (result) {
                currentUser = result;
                updateUIForRole();
                showToast('Профиль успешно обновлен', 'success');
            }
        }

        // ====== UI УПРАВЛЕНИЕ ======
        function updateUIForRole() {
            const loginBtn = document.getElementById('login-btn');
            const addProductSection = document.getElementById('add-product-section');
            const editForm = document.getElementById('edit-product-form');
            const profileTitle = document.getElementById('profile-title');
            const favoritesTab = document.getElementById('favorites-tab');
            
            if (currentUser) {
                loginBtn.textContent = `Выход (${currentUser.name})`;
                loginBtn.onclick = logout;
                loginBtn.className = 'btn btn-danger';
                profileTitle.textContent = currentUser.role === 'admin' ? 'Панель администратора' : 'Личный кабинет';
                
                if (addProductSection) {
                    addProductSection.style.display = currentUser.role === 'admin' ? 'block' : 'none';
                }
                if (editForm) {
                    editForm.style.display = currentUser.role === 'admin' ? 'block' : 'none';
                }
                if (favoritesTab) {
                    favoritesTab.style.display = currentUser.role === 'admin' ? 'none' : 'block';
                }
            } else {
                loginBtn.textContent = 'Войти';
                loginBtn.onclick = showAuthModal;
                loginBtn.className = 'btn';
                profileTitle.textContent = 'Личный кабинет';
                
                if (addProductSection) addProductSection.style.display = 'none';
                if (editForm) editForm.style.display = 'none';
                if (favoritesTab) favoritesTab.style.display = 'block';
            }
            
            updateCartCount();
        }

        function showPage(pageName) {
            const pages = ['home-page', 'product-detail-page', 'profile-page', 'checkout-page'];
            pages.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            
            if (pageName === 'home') {
                document.getElementById('home-page').style.display = 'block';
                fetchProducts();
            } else if (pageName === 'profile') {
                if (!currentUser) {
                    showToast('Войдите в систему, чтобы просмотреть личный кабинет', 'error');
                    showAuthModal();
                    return;
                }
                document.getElementById('profile-page').style.display = 'block';
                loadProfile();
                loadOrders();
                if (currentUser.role !== 'admin') {
                    loadFavorites();
                }
            } else if (pageName === 'checkout') {
                if (!currentUser) {
                    showToast('Войдите в систему для оформления заказа', 'error');
                    showAuthModal();
                    return;
                }
                document.getElementById('checkout-page').style.display = 'block';
            }
        }

        // ====== ФУНКЦИИ КОРЗИНЫ ======
        function openCart() {
            if (!currentUser) {
                showToast('Войдите в систему, чтобы просмотреть корзину', 'error');
                showAuthModal();
                return;
            }
            document.getElementById('cart-overlay').style.display = 'block';
            renderCartItems();
        }

        function closeCart() {
            document.getElementById('cart-overlay').style.display = 'none';
        }

        // ====== ИНИЦИАЛИЗАЦИЯ ======
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            document.getElementById('search').addEventListener('input', fetchProducts);
            document.getElementById('category').addEventListener('change', fetchProducts);
            document.getElementById('min-price').addEventListener('input', fetchProducts);
            document.getElementById('max-price').addEventListener('input', fetchProducts);
            document.getElementById('sort').addEventListener('change', fetchProducts);
            
            document.getElementById('add-product-form').addEventListener('submit', addProduct);
            
            document.querySelectorAll('input[name="delivery"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const addressField = document.getElementById('address-field');
                    addressField.style.display = this.value === 'courier' ? 'block' : 'none';
                });
            });
            
            document.getElementById('auth-overlay').addEventListener('click', function(e) {
                if (e.target === this) closeAuthModal();
            });
            
            document.getElementById('cart-overlay').addEventListener('click', function(e) {
                if (e.target === this) closeCart();
            });
            
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(`auth-${this.dataset.tab}`).classList.add('active');
                });
            });
            
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.profile-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    const tabId = this.dataset.tab;
                    document.getElementById(`tab-${tabId}`).classList.add('active');
                    
                    if (tabId === 'profile') {
                        loadProfile();
                    } else if (tabId === 'orders') {
                        loadOrders();
                    } else if (tabId === 'favorites' && currentUser && currentUser.role !== 'admin') {
                        loadFavorites();
                    }
                });
            });
            
            fetchProducts();
        });
    </script>
</body>
</html>